# Upstream: Postman Echo (HTTPS)
upstream site2_upstream {
  zone site2_upstream 64k;
  server postman-echo.com:443 resolve;   # runtime DNS
}

server {
  listen 443 ssl;
  server_name site2.local;

  ssl_certificate     {{ nginx_ssl_cert }};
  ssl_certificate_key {{ nginx_ssl_key }};

  # DNS for "resolve" and SNI; disable IPv6 if host lacks it
  resolver {{ nginx_resolver }} valid=30s ipv6=off;

  location / {
    proxy_pass https://site2_upstream;

    # Make Host + SNI match upstream origin
    proxy_set_header Host postman-echo.com;
    proxy_ssl_server_name on;
    proxy_ssl_name postman-echo.com;

    # Helpful timeouts/retries
    proxy_connect_timeout 10s;
    proxy_read_timeout 30s;
    proxy_next_upstream error timeout http_502 http_503 http_504;
  }
}
