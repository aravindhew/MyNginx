# Resolve the hostname at runtime (and avoid IPv6 if the host doesn't have it)
# NOTE: resolver must be in this (server) or http context for "resolve" to work.
server {
  resolver {{ nginx_resolver }} valid=30s ipv6=off;

  # Upstream with runtime DNS
  upstream site2_upstream {
    zone site2_upstream 64k;
    server nginx.org:443 resolve;
  }

  listen 443 ssl;
  server_name site2.local;

  ssl_certificate     {{ nginx_ssl_cert }};
  ssl_certificate_key {{ nginx_ssl_key }};

  location / {
    proxy_pass https://site2_upstream;

    # Make SNI + Host header match the real upstream
    proxy_set_header Host nginx.org;
    proxy_ssl_server_name on;
    proxy_ssl_name nginx.org;

    # (optional, but helps)
    proxy_connect_timeout 10s;
    proxy_read_timeout 30s;
    proxy_next_upstream error timeout http_502 http_503 http_504;
  }
}
